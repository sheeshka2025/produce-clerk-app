<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickList - Camera View</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

    <main class="w-full max-w-lg p-4 bg-white rounded-lg shadow-md">
        <div id="camera-view">
            <div id="camera-feed" class="w-full h-80 bg-gray-900 text-white flex items-center justify-center rounded-md border-2 border-gray-300 mb-4">
                <p>Camera feed will appear here</p>
            </div>
            <button id="identify-button" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                Identify Items
            </button>
        </div>

        <div id="results-view" class="hidden">
            <h2 class="text-xl font-bold mb-2 text-center">Select Items to Add:</h2>
            <div id="results-buttons" class="flex flex-col gap-2 mb-4">
                </div>
            <button id="scan-again-button" class="w-full bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">
                Scan Again
            </button>
        </div>
    </main>

    <script>
        console.log("Script is running!"); // This should appear first.

        // Get references to all the HTML elements
        const cameraView = document.getElementById('camera-view');
        const resultsView = document.getElementById('results-view');
        const cameraFeed = document.getElementById('camera-feed');
        const identifyButton = document.getElementById('identify-button');
        const resultsButtons = document.getElementById('results-buttons');
        const scanAgainButton = document.getElementById('scan-again-button');
        
        let videoElement;
        const pickList = [];

        async function startCamera() {
            console.log("1. 'startCamera' function called.");
            try {
                console.log("2. Requesting camera permission from browser...");
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                console.log("3. Permission granted and stream received.");

                console.log("4. Creating video element...");
                videoElement = document.createElement('video');
                videoElement.srcObject = stream;
                videoElement.setAttribute('playsinline', true);
                videoElement.autoplay = true;
                videoElement.classList.add('w-full', 'h-full', 'object-cover'); 

                cameraFeed.innerHTML = '';
                console.log("5. Appending video element to page.");
                cameraFeed.appendChild(videoElement);
                console.log("6. Camera should now be visible!");

            } catch (err) {
                console.error("ERROR FOUND in startCamera:", err);
            }
        }

        function showResults(labels) {
            resultsButtons.innerHTML = ''; 
            labels.forEach(label => {
                const button = document.createElement('button');
                button.textContent = label.description;
                button.classList.add('w-full', 'bg-green-500', 'hover:bg-green-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded');
                
                button.onclick = () => {
                    pickList.push(label.description);
                    console.log('Current Pick List:', pickList);
                    alert(`Added "${label.description}" to your list!`);
                    
                    button.disabled = true;
                    button.classList.remove('bg-green-500', 'hover:bg-green-700');
                    button.classList.add('bg-gray-400', 'cursor-not-allowed');
                };
                resultsButtons.appendChild(button);
});
            
            cameraView.classList.add('hidden');
            resultsView.classList.remove('hidden');
        }

        scanAgainButton.addEventListener('click', () => {
            resultsView.classList.add('hidden');
            cameraView.classList.remove('hidden');
        });
        
        identifyButton.addEventListener('click', async () => {
            if (!videoElement) {
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');

            identifyButton.textContent = 'Identifying...';
            identifyButton.disabled = true;

            try {
                const response = await fetch('/api/identify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const results = await response.json();
                
                if (results.labels && results.labels.length > 0) {
                    showResults(results.labels);
                } else {
                    alert('Nothing was detected.');
                }
                
            } catch (error) {
                console.error('Error identifying image:', error);
                alert('Could not identify the image. Please try again.');
            } finally {
                identifyButton.textContent = 'Identify Items';
                identifyButton.disabled = false;
            }
        });

        startCamera();
    </script>

</body>
</html>